# Module 1: SQL Server Architecture, Scheduling, and Waits

## 1. ‡∏ö‡∏ó‡∏ô‡∏≥ (Introduction)
‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏£‡∏Å‡∏ô‡∏µ‡πâ ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á SQL Server ‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (Performance Tuning) ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏°‡∏∏‡πà‡∏á‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏•‡πÑ‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á **SQLOS** ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Database Engine ‡πÅ‡∏•‡∏∞ Operating System

‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: SQL Server ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Application Server ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (Memory) ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (CPU Scheduling) ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏î Overhead ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤ OS ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

### 1.1 Skill Progression (‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Module ‡∏ô‡∏µ‡πâ)
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 ‚Äì ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°**
  - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á SQL Server Engine, SQLOS, Scheduler, Tasks/Workers ‡πÑ‡∏î‡πâ
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 ‚Äì ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏Ñ‡∏ß‡∏≤‡∏° Wait Statistics ‡πÑ‡∏î‡πâ**
  - ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó Resource Wait vs Signal Wait, ‡∏£‡∏∞‡∏ö‡∏∏ Wait Type ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 ‚Äì ‡πÉ‡∏ä‡πâ DMVs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á**
  - ‡πÉ‡∏ä‡πâ `sys.dm_os_schedulers`, `sys.dm_os_wait_stats`, `sys.dm_exec_requests` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î‡∏î‡πâ‡∏≤‡∏ô CPU / Waits ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 ‚Äì ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á Tuning ‡∏ï‡∏≤‡∏° Best Practice ‡∏Ç‡∏≠‡∏á Microsoft**
  - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å Module ‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å Performance Center ‡∏Ç‡∏≠‡∏á Microsoft SQL Server ‡πÅ‡∏•‡∏∞ Azure SQL Database ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏ó‡∏µ‡πà CPU, Waits, ‡πÅ‡∏•‡∏∞ Scheduling ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Tuning (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å [Performance Center for SQL Server Database Engine and Azure SQL Database](https://learn.microsoft.com/en-us/sql/relational-databases/performance/performance-center-for-sql-server-database-engine-and-azure-sql-database?view=sql-server-ver17))

---

## 2. SQL Server Components (Lesson 1)

**SQL Server** ‡∏Ñ‡∏∑‡∏≠ RDBMS ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏≤‡∏¢ Components ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Tuning

> **‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡∏ó‡∏∏‡∏Å Query ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô **Query Engine** (Compile/Optimize) ‡πÅ‡∏•‡∏∞ **Storage Engine** (Access Data) ‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Performance ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ

### 2.1 Connection Protocols
Client ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà Engine ‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏≤‡∏á "Endpoints" ‡∏ã‡∏∂‡πà‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
1.  **Shared Memory**: ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Local Connection) ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ Network Overhead
2.  **Named Pipes**: ‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ß‡∏á LAN
3.  **TCP/IP**: ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢
    *   *Modern Update (SQL 2022)*: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö **TDS 8.0** ‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ **TLS 1.3** ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Protocol

### 2.2 Database Engine Layers
‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á SQL Server ‡πÅ‡∏ö‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (Layer) ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
1.  **Query Execution Layer (Relational Engine)**: ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
    *   *Parser*: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå (Syntax)
    *   *Algebrizer*: ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á T-SQL ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (Query Tree)
    *   *Optimizer*: ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Execution Plan) ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (Cost-based Optimization)
2.  **Storage Engine Layer**: ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
    *   *Access Methods*: ‡∏Å‡∏•‡πÑ‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Table Scan, Index Seek)
    *   *Buffer Pool Manager*: ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Page
    *   *Transaction Manager*: ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Atomicity ‡πÅ‡∏•‡∏∞ Locking
3.  **SQLOS Layer**: ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏°‡∏∑‡∏≠‡∏ô OS ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Application-layer OS) ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Thread ‡πÅ‡∏•‡∏∞ Memory

---

### 2.3 SQLOS & Scheduling Models

SQLOS (SQL Server Operating System) ‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå User-mode ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà Abstract ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ Hardware ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Windows OS

#### Preemptive vs Non-Preemptive Scheduling

| Aspect | Windows (Preemptive) | SQL Server (Non-Preemptive/Cooperative) |
|:-------|:---------------------|:----------------------------------------|
| **‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î Thread** | OS ‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î (Force) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏î Time Slice | Thread ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á (Yield) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ |
| **Quantum** | ~15.6 ms (Windows default) | ~4 ms |
| **Context Switch** | OS-managed (‡∏°‡∏µ overhead ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤) | Application-managed (lightweight) |
| **Control** | OS ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° | SQL Server ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏≠‡∏á |

```mermaid
sequenceDiagram
    participant Task1
    participant Scheduler
    participant Task2
    
    Note over Task1,Task2: Non-Preemptive (Cooperative)
    
    Task1->>Scheduler: Running (uses CPU)
    Note right of Task1: Works until needs<br/>resource or hits 4ms
    Task1->>Scheduler: Yield! (I'm done/waiting)
    Scheduler->>Task2: Your turn
    Task2->>Scheduler: Running
    Task2->>Scheduler: Yield!
    Scheduler->>Task1: Resume
```

> [!NOTE]
> **‡∏ó‡∏≥‡πÑ‡∏° SQL Server ‡πÉ‡∏ä‡πâ Non-Preemptive?**
> - ‡∏•‡∏î Context Switch Overhead (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ OS ‡∏™‡∏±‡πà‡∏á)
> - SQL Server ‡∏£‡∏π‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤ OS ‡∏ß‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏∏‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠ I/O, ‡∏£‡∏≠ Lock)
> - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Database Workload

#### PREEMPTIVE_* Wait Types
‡πÄ‡∏°‡∏∑‡πà‡∏≠ SQL Server ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Windows API (‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å SQLOS ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß):
*   `PREEMPTIVE_OS_GETPROCADDRESS`: ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ DLL function
*   `PREEMPTIVE_OS_AUTHENTICATIONOPS`: Authentication operations
*   `PREEMPTIVE_OS_FILEOPS`: File operations
*   `PREEMPTIVE_OS_LIBRARYOPS`: Load/Unload DLLs

> [!TIP]
> PREEMPTIVE_* waits ‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ß‡πà‡∏≤ SQL Server ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏±‡∏ö OS calls ‡∏°‡∏≤‡∏Å ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å Linked Server, xp_cmdshell, ‡∏´‡∏£‡∏∑‡∏≠ CLR

#### NUMA Architecture
*   SQLOS ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡∏Å‡∏£‡∏£‡∏° **Non-Uniform Memory Access (NUMA)**
*   ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£‡∏á‡∏≤‡∏ô (Task) ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô Node ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Memory ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Latency ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≤‡∏° Node (Remote Memory Access)

---

### 2.4 Waits & Queues (Wait Statistics)
‡πÄ‡∏°‡∏∑‡πà‡∏≠ Thread ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Running ‡πÄ‡∏õ‡πá‡∏ô Suspended ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏≠ (Wait Type)
*   **Resource Waits**: ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ (‡πÄ‡∏ä‡πà‡∏ô Lock, Disk I/O, Network)
*   **Signal Waits**: ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ CPU ‡∏ß‡πà‡∏≤‡∏á (‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Runnable Queue)
    *   *High Signal Wait Time*: ‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ CPU Pressure (System overload)

#### Common Wait Types

**CPU-Related Waits:**
*   **SOS_SCHEDULER_YIELD**: Thread ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô CPU (Yield) ‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ CPU Pressure ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
*   **THREADPOOL**: Worker Threads ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Request (Starvation) ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏¥‡∏Å‡∏§‡∏ï‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡πà‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
*   **CXPACKET / CXCONSUMER**: Parallelism waits - Thread ‡∏£‡∏≠ Thread ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô Parallel ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à

**I/O-Related Waits:**
*   **PAGEIOLATCH_SH/EX**: ‡∏£‡∏≠ Data Page ‡∏à‡∏≤‡∏Å Disk (Physical Read) - ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ Disk bottleneck ‡∏´‡∏£‡∏∑‡∏≠ Memory pressure
*   **WRITELOG**: ‡∏£‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Transaction Log (Log Buffer ‚Üí LDF) - ‡∏Ñ‡πà‡∏≤‡∏™‡∏π‡∏á‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ Log disk ‡∏ä‡πâ‡∏≤
*   **ASYNC_IO_COMPLETION**: ‡∏£‡∏≠ Async I/O ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Backup, Checkpoint)
*   **IO_COMPLETION**: ‡∏£‡∏≠ I/O ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Data pages (‡πÄ‡∏ä‡πà‡∏ô Sort, Hash operations)

**Memory-Related Waits:**
*   **RESOURCE_SEMAPHORE**: ‡∏£‡∏≠ Memory Grant ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Sort/Hash - Query ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
*   **CMEMTHREAD**: Memory object contention - ‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏±‡∏ö Plan Cache

**Lock/Blocking-Related Waits:**

Lock ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏•‡πÑ‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏≤‡∏¢ Transaction ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡∏™‡πà‡∏ß‡∏ô Latch ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏•‡πÑ‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Memory (‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô Module 05)

*   **LCK_M_\***: ‡∏£‡∏≠ Lock ‡∏ö‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (S=Shared ‡∏≠‡πà‡∏≤‡∏ô, X=Exclusive ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô, U=Update ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô)
*   **PAGELATCH_\***: ‡∏£‡∏≠ Latch ‡∏ö‡∏ô Buffer Pool pages - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏≤‡∏¢ Thread ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÉ‡∏ô Memory (‡∏°‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏±‡∏ö TempDB Allocation Pages)

**Network-Related Waits:**
*   **ASYNC_NETWORK_IO**: SQL Server ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà Client ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô

**Background/System Waits:**
*   **LOGBUFFER**: ‡∏£‡∏≠ Log Buffer ‡∏ß‡πà‡∏≤‡∏á - Transaction rate ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏
*   **BACKUPTHREAD**: ‡∏Ç‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£ Backup ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
*   **PREEMPTIVE_OS_***: SQL Server ‡∏£‡∏≠ Windows API calls (‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å SQLOS ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)

### 2.5 Request Execution Flow & DMVs

‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á SQL Server ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà Connection ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á Execution ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ DMV ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:

#### Execution Flow Stages:

| # | Stage | Description | DMV |
|:--:|:------|:------------|:-----|
| 1Ô∏è‚É£ | **Connection** | Client ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ | `sys.dm_exec_connections` |
| 2Ô∏è‚É£ | **Session** | ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Session ID | `sys.dm_exec_sessions` |
| 3Ô∏è‚É£ | **Request** | ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (Query/Batch) | `sys.dm_exec_requests` |
| 4Ô∏è‚É£ | **Task(s)** | ‡πÅ‡∏ö‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Parallel?) | `sys.dm_os_tasks` |
| 5Ô∏è‚É£ | **Worker** | Task ‡∏ñ‡∏π‡∏Å‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏´‡πâ Worker | `sys.dm_os_workers` |
| 6Ô∏è‚É£ | **Thread** | Worker ‡πÉ‡∏ä‡πâ OS Thread ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ô | `sys.dm_os_threads` |
| 7Ô∏è‚É£ | **Scheduler** | ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Tasks | `sys.dm_os_schedulers` |

#### Special DMVs for Troubleshooting:

| DMV | Purpose | Best Used For |
|:-----|:--------|:--------------|
| `sys.dm_os_waiting_tasks` | ‡πÅ‡∏™‡∏î‡∏á Tasks ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á **‡∏£‡∏≠** ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ (SUSPENDED state) | üîç Real-time Blocking Analysis |
| `sys.dm_os_wait_stats` | ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á Wait Types ‡∏ó‡∏±‡πâ‡∏á Server | üìä Cumulative Wait Analysis |
| `sys.dm_exec_query_stats` | ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á Query Plans ‡πÉ‡∏ô Cache | üìà Historical Query Performance |

> [!TIP]
> **‡πÄ‡∏•‡∏∑‡∏≠‡∏Å DMV ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°:**
> - ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π **‡πÉ‡∏Ñ‡∏£‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ** ‚Üí `sys.dm_os_waiting_tasks`
> - ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π **‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏∞‡∏™‡∏°** ‚Üí `sys.dm_os_wait_stats`

### 2.6 Schedulers, Workers, and Tasks
‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢ 3 ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å:
1.  **Scheduler**: ‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á Logical CPU (1 Core = 1 Scheduler)
2.  **Worker**: Thread ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà SQLOS ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô
    *   *Max Worker Threads*: ‡πÇ‡∏î‡∏¢‡∏õ‡∏Å‡∏ï‡∏¥ SQL Server ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Dynamic Scaling)
3.  **Task**: ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• (Batch Request)

### 2.7 Scheduling Mechanics (Deep Dive)

1.  **Cooperative Scheduling & LDF**:
    *   SQL Server ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà Thread ‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏≠‡∏á (Yield)
    *   **Large Deficit First (LDF)**: ‡∏≠‡∏±‡∏•‡∏Å‡∏≠‡∏£‡∏¥‡∏ó‡∏∂‡∏° (SQL 2016+) ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Thread ‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏ä‡πà‡∏ô Read-Ahead) ‡πÅ‡∏¢‡πà‡∏á CPU ‡∏à‡∏ô Thread ‡πÄ‡∏•‡πá‡∏Å‡πÜ (Worker) ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô

2.  **Hidden Schedulers**:
    *   ‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Scheduler ‡∏õ‡∏Å‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö CPU ‡πÅ‡∏•‡πâ‡∏ß ‡∏¢‡∏±‡∏á‡∏°‡∏µ **Hidden Schedulers** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
    *   *System Tasks*: Ghost Cleanup, Query Store Async, Checkpoint
    *   *DAC Scheduler*: Dedicated Admin Connection (‡∏Å‡∏π‡πâ‡∏ä‡∏µ‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠ Server ‡∏Ñ‡πâ‡∏≤‡∏á)

> [!WARNING]
> **Fiber Mode (Lightweight Pooling)**: ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏¢‡∏∏‡∏Ñ 90s ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ 1 Thread ‡πÅ‡∏ö‡∏Å‡∏´‡∏•‡∏≤‡∏¢ Fiber (User Mode Scheduling) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Context Switch
> *   *Concept*: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° "‡πÇ‡∏Å‡∏á" OS ‡πÇ‡∏î‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Task ‡πÄ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ OS ‡πÄ‡∏´‡πá‡∏ô
> *   *Status*: **Deprecated** (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡πÉ‡∏ô SQL 2025+) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏û‡∏±‡∏á (‡πÄ‡∏ä‡πà‡∏ô CLR, XML, Linked Server) ‡πÅ‡∏•‡∏∞ CPU ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏£‡∏á‡∏û‡∏≠‡πÅ‡∏•‡πâ‡∏ß

### 2.8 The Lifecycle of a Scheduler (State Machine)
‡∏ß‡∏á‡∏à‡∏£‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Thread ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

1.  **RUNNING**: Thread ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ CPU
    *   *Quantum*: ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà Thread ‡∏Ñ‡∏£‡∏≠‡∏á CPU ‡πÑ‡∏î‡πâ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 4ms) ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Yield)
2.  **SUSPENDED**: Thread ‡∏´‡∏¢‡∏∏‡∏î‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á "‡∏£‡∏≠" ‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á
    *   ‡∏£‡∏≠ I/O (Disk) -> `PAGEIOLATCH_SH`
    *   ‡∏£‡∏≠ Lock (Resource) -> `LCK_M_X`
3.  **RUNNABLE**: Thread ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏≠‡πÑ‡∏î‡πâ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß) ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡∏ï‡πà‡∏≠‡∏Ñ‡∏¥‡∏ß (Signal Queue) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠ Scheduler ‡∏ß‡πà‡∏≤‡∏á
    *   *Signal Wait Time*: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏™‡∏π‡∏á‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤ **CPU Pressure**

---

### 2.8 Thread Life Cycle Diagram (Visualized)
```mermaid
stateDiagram-v2
    [*] --> RUNNABLE: New Task
    RUNNABLE --> RUNNING: Scheduler Picks Task
    RUNNING --> SUSPENDED: Needs Resource (Disk/Lock)
    SUSPENDED --> RUNNABLE: Resource Ready (Signal)
    RUNNING --> RUNNABLE: Quantum Exhausted (Yield)
    RUNNING --> [*]: Task Completed

    state "RUNNABLE\n(Signal Wait)" as RUNNABLE
    state "RUNNING\n(Service Time)" as RUNNING
    state "SUSPENDED\n(Resource Wait)" as SUSPENDED
```

---

## 3. Wait Statistics Analysis

‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Wait Stats ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏≠‡∏Ç‡∏ß‡∏î (Bottleneck) ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö

### 3.1 Resource Waits vs Signal Waits
‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á (Response Time):
$$ \text{Response Time} = \text{Service Time (CPU)} + \text{Wait Time} $$

*   **Service Time**: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á
*   **Wait Time**: ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠
    *   **Resource Waits**: ‡∏£‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£ (Disk, Network, Lock) -> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î Contention
    *   **Signal Waits**: ‡∏£‡∏≠ CPU -> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏î CPU Consumption ‡∏Ç‡∏≠‡∏á Query ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° CPU Core

### 3.2 Top Wait Types Analysis
1.  **CXPACKET / CXCONSUMER**: ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡∏≠‡∏á‡∏Å‡∏±‡∏ö Parallelism
    *   *Analysis*: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö `MAXDOP` ‡πÅ‡∏•‡∏∞ `Cost Threshold for Parallelism` ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö Workload
2.  **PAGEIOLATCH_XX**: ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Disk
    *   *Analysis*: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Memory Pressure (Buffer Pool) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Query ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Logical Reads
3.  **LCK_M_XX**: ‡∏Å‡∏≤‡∏£‡∏£‡∏≠ Lock
    *   *Analysis*: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Blocking Chain ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏£‡∏±‡∏ö Isolation Level ‡∏´‡∏£‡∏∑‡∏≠ Index
4.  **WRITELOG**: ‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Transaction Log
    *   *Analysis*: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Disk Latency ‡∏Ç‡∏≠‡∏á Log File
5.  **ASYNC_NETWORK_IO**: ‡∏ù‡∏±‡πà‡∏á Application ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πâ‡∏≤‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏µ‡πà SQL ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ
    *   *Analysis*: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Application Logic (‡πÄ‡∏ä‡πà‡∏ô Row-by-row processing)

---

## 4. Modern SQL Server Features (2019, 2022+)

### 4.1 Lightweight Query Profiling
*   ‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î Trace ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Execution Plan ‡∏°‡∏µ Overhead ‡∏™‡∏π‡∏á
*   ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô SQL Server ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô **Lightweight Profiling** ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Default) ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö `sys.dm_exec_query_profiles` ‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö Real-time ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ô‡πâ‡∏≠‡∏¢‡∏°‡∏≤‡∏Å

### 4.2 Modern Hardware Support
*   **Persistent Memory (PMEM)**: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á Data/Log file ‡∏ö‡∏ô PMEM ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Latency ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏∞‡∏î‡∏±‡∏ö Microsecond
*   **Intel QuickAssist Technology (QAT)**: SQL Server 2022 ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ Offload ‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Compression) ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Hardware ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏†‡∏≤‡∏£‡∏∞ CPU

---

## 5. Lab & Exercises
‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏•‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå `Scripts/`:
1.  **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå CPU Pressure**: ‡∏£‡∏±‡∏ô `01_Check_Schedulers.sql` ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ Workload ‡∏´‡∏ô‡∏±‡∏Å ‡πÜ ‡∏î‡∏π‡∏Ñ‡πà‡∏≤ `runnable_tasks_count`
2.  **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö**: ‡∏£‡∏±‡∏ô `02_Wait_Stats_Analysis.sql` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Top 3 ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Server ‡∏ô‡∏µ‡πâ
3.  **Real-time Troubleshooting**: ‡∏£‡∏±‡∏ô `03_Current_Executing_Requests.sql` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏£‡∏±‡∏ô‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏¥‡∏î Wait ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà

> **Tip**: ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏°‡∏≠‡∏á‡∏´‡∏≤ Pattern ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏á 9 ‡πÇ‡∏°‡∏á" (Baseline ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ) ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡πâ‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Procedure ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ" (Query Plan ‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ)

---

## 6. Review Quiz (Knowledge Check)

<details>
<summary><b>1. ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏ß‡πà‡∏≤ Wait Type ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ CXPACKET ‡πÅ‡∏•‡∏∞ CXCONSUMER ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£?</b></summary>
‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á Parallel Execution ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤ CXPACKET ‡∏™‡∏π‡∏á‡πÇ‡∏î‡∏î‡πÜ ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏π‡∏ô Cost Threshold for Parallelism ‡∏´‡∏£‡∏∑‡∏≠ MAXDOP
</details>

<details>
<summary><b>2. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Signal Wait ‡πÅ‡∏•‡∏∞ Resource Wait ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</b></summary>
Resource Wait ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏≠‡∏Ç‡∏≠‡∏á (‡πÄ‡∏ä‡πà‡∏ô Disk/Lock) ‡πÅ‡∏ï‡πà Signal Wait ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß "‡∏£‡∏≠ CPU ‡∏ß‡πà‡∏≤‡∏á" (‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å CPU Pressure)
</details>

<details>
<summary><b>3. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ SUSPENDED ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á Thread ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£?</b></summary>
Thread ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Disk ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡∏õ‡∏•‡∏î Lock)
</details>

