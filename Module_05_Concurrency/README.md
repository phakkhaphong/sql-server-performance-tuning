# Module 5: SQL Server Concurrency

## 1. ‡∏ö‡∏ó‡∏ô‡∏≥ (Introduction)
Concurrency ‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Consistency) ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û (Performance) ‡πÑ‡∏ß‡πâ‡πÑ‡∏î‡πâ ‡∏Å‡∏•‡πÑ‡∏Å‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà SQL Server ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Concurrency ‡∏Ñ‡∏∑‡∏≠ **Locking** ‡πÅ‡∏•‡∏∞ **Transaction Isolation Levels**

‡πÉ‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ ‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏à‡∏∞‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Concurrency Models, Transaction Properties (ACID), ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Isolation Levels ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Blocking

### 1.1 Skill Progression (‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Module ‡∏ô‡∏µ‡πâ)
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 1 ‚Äì ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ACID ‡πÅ‡∏•‡∏∞ Isolation Levels**
  - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Pessimistic/Optimistic Concurrency, Isolation Level ‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á ‡πÄ‡∏ä‡πà‡∏ô Dirty/Non-repeatable/Phantom Reads ‡πÑ‡∏î‡πâ
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 2 ‚Äì ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Lock/Blocking ‡πÑ‡∏î‡πâ**
  - ‡πÉ‡∏ä‡πâ DMV ‡πÄ‡∏ä‡πà‡∏ô `sys.dm_tran_locks`, `sys.dm_exec_requests` ‡πÅ‡∏•‡∏∞‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÅ‡∏•‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π Blocking Chain, Lock Modes/Granularity ‡πÑ‡∏î‡πâ
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 3 ‚Äì ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Concurrency Model ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö**
  - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ READ COMMITTED, RCSI, SNAPSHOT ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö Workload, ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ç‡πâ‡∏≠‡∏î‡∏µ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢/‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠ TempDB ‡πÅ‡∏•‡∏∞ Version Store
- **‡∏£‡∏∞‡∏î‡∏±‡∏ö 4 ‚Äì ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Deadlock ‡πÅ‡∏•‡∏∞ Contention ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á**
  - ‡πÉ‡∏ä‡πâ XEvents/`system_health`, ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Deadlock Graph, ‡πÅ‡∏•‡∏∞‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏•‡∏î Deadlock, Lock Escalation, Latch/Spinlock Contention ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô

---

## 2. Concurrency and Transactions (Lesson 1)

### 2.1 Concurrency Models
1.  **Pessimistic Concurrency**: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÇ‡∏î‡∏¢‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á (Conflict) ‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏™‡∏°‡∏≠ ‡∏à‡∏∂‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Lock ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    *   *Result*: ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô Data Consistency ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î Blocking ‡∏™‡∏π‡∏á (‡πÄ‡∏õ‡πá‡∏ô Default Behavior ‡∏Ç‡∏≠‡∏á SQL Server)
2.  **Optimistic Concurrency**: ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û ‡πÇ‡∏î‡∏¢‡∏™‡∏±‡∏ô‡∏ô‡∏¥‡∏©‡∏ê‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á ‡∏à‡∏∂‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Lock ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏≠‡πà‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Validation) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Commit ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Row Versioning
    *   *Result*: ‡∏•‡∏î Blocking ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏•‡πÑ‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Conflict ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏±‡πâ‡∏ô

### 2.2 Transaction Internals
Transaction ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏£‡∏Å‡∏∞ (Logical Unit of Work) ‡∏ã‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥ **ACID**:
*   **Atomicity**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
*   **Consistency**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î Integrity Constraints)
*   **Isolation**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¥‡∏™‡∏£‡∏∞ (Transaction ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏≠‡∏µ‡∏Å Transaction ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏ô‡∏≤‡∏ô‡∏Å‡∏±‡∏ô)
*   **Durability**: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏á‡∏ó‡∏ô (‡πÄ‡∏°‡∏∑‡πà‡∏≠ Commit ‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ñ‡∏≤‡∏ß‡∏£‡πÅ‡∏°‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏•‡πà‡∏°)

*Transaction Modes*:
1.  **Auto-commit** (Default): ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô 1 Transaction ‡πÅ‡∏•‡∏∞ Commit ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
2.  **Explicit**: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏î‡πâ‡∏ß‡∏¢ `BEGIN TRAN`, `COMMIT`, `ROLLBACK`
3.  **Implicit**: ‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á DML ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πà‡∏á Commit/Rollback ‡πÄ‡∏≠‡∏á

### 2.3 Isolation Levels
‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å Transaction (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å):
1.  **READ UNCOMMITTED**: ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Commit (Dirty Read) -> ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏™‡∏π‡∏á
2.  **READ COMMITTED** (Default): ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà Commit ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Dirty Read)
3.  **REPEATABLE READ**: ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏ô‡∏à‡∏ö Transaction (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Non-Repeatable Read)
4.  **SERIALIZABLE**: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏£‡∏Å‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Phantom Read) -> ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ Blocking ‡πÅ‡∏•‡∏∞ Deadlock ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
5.  **SNAPSHOT**: ‡πÉ‡∏ä‡πâ Row Versioning ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠ Lock

### 2.4 Modern Concurrency (RCSI)
**Read Committed Snapshot Isolation (RCSI)** ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á READ COMMITTED ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Row Versioning ‡πÅ‡∏ó‡∏ô Locking
*   *Mechanism*: Reader ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Version Store (TempDB) ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏≠ Lock ‡∏à‡∏≤‡∏Å Writer
*   *Benefit*: ‡∏•‡∏î Blocking ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Reader ‡πÅ‡∏•‡∏∞ Writer ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•

---

## 3. Locking Internals (Lesson 2)

### 3.1 Locking Architecture
*   **Lock Manager**: ‡∏Å‡∏•‡πÑ‡∏Å‡∏†‡∏≤‡∏¢‡πÉ‡∏ô (Internal Mechanism) ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Lock ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
*   **Lock Granularity**: ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Lock (Hierarchy)
    *   *RID*: Row Identifier (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Heap)
    *   *KEY*: Lock ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö Index Key (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö B-Tree)
    *   *PAGE*: Lock ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö Page (8KB)
    *   *EXTENT*: Lock ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö Extent (64KB)
    *   *HoBT* (Heap or B-Tree): Lock ‡∏ó‡∏±‡πâ‡∏á Partition
    *   *TABLE*: Lock ‡∏ó‡∏±‡πâ‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    *   *DATABASE*: Lock ‡∏ó‡∏±‡πâ‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

### 3.2 Lock Modes
*   **S (Shared)**: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô (Read) ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
*   **X (Exclusive)**: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Write) ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ã‡πâ‡∏≠‡∏ô
*   **U (Update)**: ‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Deadlock ‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Update (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å S -> U -> X)
*   **IS/IX (Intent)**: "Intent Lock" ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏°‡πà (Hierarchy) ‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Lock ‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏•‡∏π‡∏Å
*   **Sch-S/Sch-M (Schema)**: Lock ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ DDL ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ Active Transaction)

#### Lock Compatibility Matrix

#### Lock Compatibility Matrix

| Request \ Granted | **IS** | **S** | **U** | **IX** | **X** |
|:------------------|:------:|:-----:|:-----:|:------:|:-----:|
| **IS** (Intent Shared) | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **S** (Shared) | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **U** (Update) | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| **IX** (Intent Exclusive) | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| **X** (Exclusive) | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

> **Legend:** ‚úÖ = Compatible (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ) | ‚ùå = Incompatible (‡πÄ‡∏Å‡∏¥‡∏î Blocking)

> [!NOTE]
> **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:**
> - **S + S = ‚úÖ** ‚Üí ‡∏≠‡πà‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô
> - **S + X = ‚ùå** ‚Üí ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
> - **X + X = ‚ùå** ‚Üí ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (Blocking ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)

### 3.3 Lock Escalation
*   **Concept**: ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö Lock ‡∏à‡∏≤‡∏Å‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (Row/Page) ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏¢‡∏≤‡∏ö (Table) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Memory Overhead
*   **Trigger Conditions** (‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡∏Ç‡πâ‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á):
    1.  **Lock Count**: ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Lock ‡πÄ‡∏Å‡∏¥‡∏ô **5,000 Locks** ‡πÉ‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏∂‡πà‡∏á Table)
    2.  **Memory Threshold**: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Memory ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Lock ‡πÄ‡∏Å‡∏¥‡∏ô **24%** ‡∏Ç‡∏≠‡∏á Memory ‡∏ó‡∏µ‡πà Database Engine ‡πÉ‡∏ä‡πâ (‡∏´‡∏£‡∏∑‡∏≠ 40% ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ `locks` option)
    *   *Retry*: ‡∏´‡∏≤‡∏Å Escalate ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πà‡∏ô‡∏ï‡∏¥‡∏î Conflict) ‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡πÜ **1,250 Locks** ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô
*   **Trade-off**: ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ ‡πÅ‡∏ï‡πà‡∏•‡∏î Concurrency ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (Table Lock)
*   **Control**: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ `ALTER TABLE SET LOCK_ESCALATION = AUTO` (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Escalate ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏î‡∏±‡∏ö Partition ‡πÅ‡∏ó‡∏ô Table)

### 3.4 Optimized Locking (SQL Server 2022+)

> [!IMPORTANT]
> **Optimized Locking** ‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô SQL Server 2022 ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö‡∏ö Locking ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏ç‡πà

**‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å: Transaction ID (TID) Locking**
‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠ Row/Page Locks ‡∏ï‡∏•‡∏≠‡∏î Transaction, SQL Server 2022 ‡πÉ‡∏ä‡πâ:
1. **Lock After Qualification (LAQ)**: ‡∏£‡∏≠‡∏à‡∏ô‡∏´‡∏≤ Row ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ Lock
2. **TID Lock**: ‡∏ñ‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà Lock ‡∏ö‡∏ô Transaction ID ‡πÅ‡∏ó‡∏ô Row Lock

| Aspect | Traditional Locking | Optimized Locking |
|:-------|:---------------------|:------------------|
| **Row Locks** | ‡∏ñ‡∏∑‡∏≠‡∏ï‡∏•‡∏≠‡∏î Transaction | ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á Modify |
| **Memory Usage** | ‚ö†Ô∏è ‡∏™‡∏π‡∏á (‡∏´‡∏•‡∏≤‡∏¢ Locks) | ‚úÖ ‡∏ï‡πà‡∏≥ (‡πÅ‡∏Ñ‡πà TID Lock) |
| **Lock Escalation** | ‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏ö‡πà‡∏≠‡∏¢ | ‚úÖ ‡πÅ‡∏ó‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏î |
| **Blocking** | ‚ö†Ô∏è ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ | ‚úÖ ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ |

```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Optimized Locking ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
SELECT name, is_optimized_locking_on
FROM sys.databases
WHERE name = DB_NAME();
```

> [!NOTE]
> Optimized Locking ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö **ADR (Accelerated Database Recovery)** ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

### 3.5 Key-Range Locking

‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô **Phantom Reads** ‡πÉ‡∏ô SERIALIZABLE Isolation Level:

*   **Mechanism**: Lock ‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á Key Values ‡πÉ‡∏ô Index ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞ Lock ‡πÅ‡∏Ñ‡πà Row ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
*   **Use Case**: `WHERE Price BETWEEN 10 AND 20` ‡∏à‡∏∞ Lock ‡∏ó‡∏±‡πâ‡∏á‡∏ä‡πà‡∏ß‡∏á 10-20 ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ INSERT ‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ

#### Key-Range Lock Modes

| Mode | Description |
|------|-------------|
| **RangeS-S** | Shared range, Shared resource (SELECT) |
| **RangeS-U** | Shared range, Update resource |
| **RangeI-N** | Insert range, Null resource (Prevent inserts) |
| **RangeX-X** | Exclusive range, Exclusive resource |

> [!WARNING]
> **SERIALIZABLE + Key-Range Locking** = Blocking ‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Consistency ‡πÅ‡∏ö‡∏ö 100%

### 3.6 Parallelism Configuration (Microsoft Best Practices)
‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Parallelism ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤ `CXPACKET` wait type ‡πÅ‡∏•‡∏∞ CPU Overhead:

1.  **Max Degree of Parallelism (MAXDOP)**: ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô CPU Cores ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠ 1 Query
    *   *Default*: 0 (‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å Cores) -> **‡πÑ‡∏°‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Server ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ Core ‡πÄ‡∏¢‡∏≠‡∏∞
    *   *Recommendation*:
        *   NUMA Node > 8 cores: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ = 8
        *   NUMA Node < 8 cores: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Cores ‡πÉ‡∏ô Node
    *   *Goal*: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Query ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÅ‡∏¢‡πà‡∏á CPU ‡πÑ‡∏õ‡∏à‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á

2.  **Cost Threshold for Parallelism**: ‡πÄ‡∏Å‡∏ì‡∏ë‡πå Cost ‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ó‡∏≥ Parallel
    *   *Default*: 5 (‡∏Ñ‡πà‡∏≤‡πÇ‡∏ö‡∏£‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡∏¢‡∏∏‡∏Ñ 90s) -> ‡∏ï‡πà‡∏≥‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ Query ‡πÄ‡∏•‡πá‡∏Å‡πÜ ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏≥ Parallel ‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏î Overhead ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Thread ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    *   *Recommendation*: ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô **25 - 50**

> [!TIP]
> ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ **Excessive Parallelism** ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ Code

### 3.7 Locking Hints
‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Query Hint ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Ç‡∏≠‡∏á Lock Manager (‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á):
*   `NOLOCK`: ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Read Uncommitted (Ignore Locks) -> ‡∏≠‡∏≤‡∏à‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Dirty Read)
*   `XLOCK`: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏≠ Exclusive Lock ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
*   `TABLOCK`: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ Table Lock ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Overhead ‡∏Ç‡∏≠‡∏á Row Lock (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Bulk Load)
*   `READPAST`: ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î Lock ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢ (‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Queue Processing)

### 3.8 Deep Dive: Locking & Versioning Mechanics (from Architecture Guide)

1.  **Dynamic Locking Strategy**:
    *   *Example*: Index Scan ‡∏≠‡∏≤‡∏à‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ **Page Lock** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Overhead ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Row locks ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•

    > [!NOTE]
    > **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ (Timing)**:
    > - **Dynamic Locking** ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÅ‡∏ö‡∏ö **Proactive** (‡∏Ñ‡∏¥‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥) ‡πÇ‡∏î‡∏¢ Query Optimizer ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Granularity ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° Plan
    > - **Lock Escalation** ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö **Reactive** (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô) ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Memory ‡πÄ‡∏Å‡∏¥‡∏ô‡πÇ‡∏Ñ‡∏ß‡∏ï‡∏≤ ‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Row -> Table ‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏±‡∏ô

2.  **Lock Partitioning (Advanced)**:
    *   ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ CPU >= 16 Cores SQL Server ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ **Lock Partitioning** ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    *   *Concept*: ‡πÅ‡∏¢‡∏Å Lock Resource ‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏° NUMA Node ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î Contention ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠ Lock (‡πÅ‡∏¢‡πà‡∏á‡∏Å‡∏±‡∏ô‡∏à‡∏≠‡∏á)

3.  **Special Lock Types**:
    *   **Sch-S (Schema Stability)**: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≠‡∏ô Validate Schema ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Compile Query (‡πÑ‡∏°‡πà Block ‡πÉ‡∏Ñ‡∏£ ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô DDL)
    *   **Sch-M (Schema Modification)**: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏≥ DDL (Alter Table, Rebuild Index) -> **Block ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á** ‡πÅ‡∏°‡πâ‡πÅ‡∏ï‡πà NOLOCK
    *   **BU (Bulk Update)**: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ `BULK INSERT` ‡∏´‡∏£‡∏∑‡∏≠ `bcp` ‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ö hint `TABLOCK` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏≤‡∏¢ Thread ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Table ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

3.  **Snapshot Update Conflicts (Error 3960)**:
    *   ‡πÉ‡∏ô Isolation Level **SNAPSHOT** (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà RCSI) ‡∏´‡∏≤‡∏Å Transaction A ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ô‡∏±‡πâ‡∏ô Transaction B ‡∏ä‡∏¥‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞ Commit ‡∏ï‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
    *   *Result*: Transaction A ‡∏à‡∏∞‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏î‡πâ‡∏ß‡∏¢ **Error 3960** (Snapshot Isolation Transaction Aborted due to Update Conflict)
    *   *Fix*: Application ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Logic ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ **Retry** Transaction ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà

### 3.9 Latches & Spinlocks (Internal Synchronization)

‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Lock ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß SQL Server ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Å‡∏•‡πÑ‡∏Å‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Engine ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏•‡∏≤‡∏¢ Thread ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

**üè† ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô:**
- **Lock** = ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô (‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á = Data) - ‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏≤‡∏ô ‡∏£‡∏≠‡πÑ‡∏î‡πâ
- **Latch** = ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô (‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß = Buffer Pages) - ‡∏•‡πá‡∏≠‡∏Å‡∏™‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏ô‡∏≤‡∏ô
- **Spinlock** = ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü (‡πÉ‡∏ä‡πâ‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß = Internal Structures) - ‡∏¢‡∏∑‡∏ô‡∏£‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏£‡∏á‡∏ô‡∏±‡πâ‡∏ô

**‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö?**
‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Å‡∏≤‡∏£ "‡∏£‡∏≠" ‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô (Context Switch) ‡∏ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏Ñ‡πà‡πÅ‡∏õ‡πä‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏Å‡∏≤‡∏£‡∏ß‡∏ô‡∏£‡∏≠ CPU ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ô‡∏≠‡∏ô‡∏£‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏•‡∏∏‡∏Å‡πÉ‡∏´‡∏°‡πà

#### Lock Hierarchy: Lock ‚Üí Latch ‚Üí Spinlock

| Type | ‡πÉ‡∏ä‡πâ‡∏õ‡∏Å‡∏õ‡πâ‡∏≠‡∏á‡∏≠‡∏∞‡πÑ‡∏£ | ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ | ‡∏ñ‡∏∑‡∏≠‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô | Wait Type |
|:-----|:--------------|:------------|:-------------|:----------|
| üîí **Lock** | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Row, Page, Table) | Thread ‡∏ô‡∏≠‡∏ô‡∏£‡∏≠ (Blocking) | ‡∏ô‡∏≤‡∏ô (‡∏ï‡∏•‡∏≠‡∏î Transaction) | `LCK_M_*` |
| üîê **Latch** | ‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Memory (Buffer Pool) | Thread ‡∏ô‡∏≠‡∏ô‡∏£‡∏≠ (Blocking) | ‡∏™‡∏±‡πâ‡∏ô | `PAGELATCH_*` |
| ‚öôÔ∏è **Spinlock** | ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Engine | Thread ‡∏ß‡∏ô‡∏•‡∏π‡∏õ (Spinning) | ‡∏™‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Å | ‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÉ‡∏ä‡πâ CPU ‡∏ß‡∏ô‡∏•‡∏π‡∏õ) |

#### Latch Types
*   `PAGELATCH_SH/EX`: Latch ‡∏ö‡∏ô Data Page ‡πÉ‡∏ô Buffer Pool
*   `PAGEIOLATCH_SH/EX`: ‡∏£‡∏≠ I/O ‡∏Ç‡∏≠‡∏á Page (Disk ‚Üí Memory)
*   `LATCH_SH/EX`: Latch ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏ô Hash Tables)

#### Spinlock Contention (Advanced)

Spinlocks ‡∏°‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏±‡∏ö Server ‡∏ó‡∏µ‡πà‡∏°‡∏µ **24+ CPU Cores**

**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:**
*   **High CPU** ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ Wait Type ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
*   `SOS_SCHEDULER_YIELD` Wait ‡∏™‡∏π‡∏á
*   CPU Utilization ‡∏™‡∏π‡∏á‡πÅ‡∏ï‡πà Throughput ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°

```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Spinlock Statistics
SELECT 
    name AS [Spinlock Name],
    spins AS [Spins],
    spins_per_collision AS [Spins/Collision],
    backoffs AS [Backoffs],
    sleep_time AS [Sleep Time]
FROM sys.dm_os_spinlock_stats
ORDER BY spins DESC;
```

#### Common Spinlock Issues

| Spinlock | Cause | Solution |
|:---------|:-----|:---------|
| `LOCK_HASH` | High lock volume | Reduce lock duration, use RCSI |
| `SOS_OBJECT_STORE` | Heavy object allocation | Reduce temp table creation |
| `LOGCACHE_ACCESS` | High transaction rate | Batch transactions |
| `OPT_IDX_STATS` | Statistics contention | Update stats off-peak |

> [!NOTE]
> **SQL Server 2022** ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Spinlock Algorithm ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô

### 3.10 Deadlocks (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)

Deadlock ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ Transaction ‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß (‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤) ‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ã‡∏∂‡πà‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô (Cyclic Dependency)

```mermaid
graph LR
    T1[Transaction A] -->|Holds Lock on| R1[Row 1]
    T2[Transaction B] -->|Holds Lock on| R2[Row 2]
    T1 -->|Wants Lock on| R2
    T2 -->|Wants Lock on| R1
    style T1 fill:#f99
    style T2 fill:#f99
```

#### Deadlock Detection & Resolution
*   **Lock Monitor Thread**: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡∏•‡∏î‡∏•‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏∏‡∏Å 100ms ‡∏´‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö Deadlock ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
*   **Victim Selection**: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Transaction ‡∏ó‡∏µ‡πà‡∏°‡∏µ Log Records ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ (Cost to Rollback ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤)
*   **Error 1205**: Transaction ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Victim ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Error ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å Rollback

#### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏•‡∏î Deadlocks

| Strategy | Description |
|:---------|:------------|
| üîÑ **Access Order** | ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Objects ‡πÉ‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏™‡∏°‡∏≠ |
| ‚ö° **Short Transactions** | ‡∏ó‡∏≥ Transaction ‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô, Commit ‡πÄ‡∏£‡πá‡∏ß |
| üö´ **Avoid User Interaction** | ‡∏´‡πâ‡∏≤‡∏° Wait user input ‡πÉ‡∏ô Transaction |
| üì∏ **Use RCSI** | ‡πÉ‡∏ä‡πâ Row Versioning ‡πÅ‡∏ó‡∏ô Shared Locks |
| üìä **Indexes** | Query ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Index ‡∏ñ‡∏∑‡∏≠ Lock ‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ Table Scan |

#### Deadlock Tools

| Tool | Description |
|:-----|:------------|
| `system_health` XEvent | üîç ‡∏à‡∏±‡∏ö Deadlock Graph ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ |
| `xml_deadlock_report` XEvent | üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á XEvent session ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Deadlocks |
| Error Log | üìã Trace Flag 1222 ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Detailed Deadlock info |

```sql
-- ‡∏î‡∏π Deadlock ‡∏à‡∏≤‡∏Å system_health XEvent
SELECT XEvent.query('(event/data/value/deadlock)[1]') AS deadlock_graph
FROM (
    SELECT CAST(target_data AS XML) AS TargetData
    FROM sys.dm_xe_session_targets st
    INNER JOIN sys.dm_xe_sessions s ON s.address = st.event_session_address
    WHERE s.name = 'system_health' AND st.target_name = 'ring_buffer'
) AS Data
CROSS APPLY TargetData.nodes('RingBufferTarget/event[@name="xml_deadlock_report"]') AS XEventData(XEvent);
```

---

## 4. Modern Concurrency Features

### 4.1 Row Versioning-Based Isolation Levels

SQL Server ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2 ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á Row Versioning:

#### RCSI vs Snapshot Isolation

| Feature | READ_COMMITTED_SNAPSHOT (RCSI) | SNAPSHOT Isolation |
|:--------|:------------------------------|:-------------------|
| **‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô** | Database option | Database option + Session level |
| **Scope** | Statement-level consistency | Transaction-level consistency |
| **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô** | Committed ‡∏ì ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° Statement | Committed ‡∏ì ‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° Transaction |
| **Update Conflicts** | ‡πÑ‡∏°‡πà‡∏°‡∏µ (‡πÉ‡∏ä‡πâ Lock ‡∏õ‡∏Å‡∏ï‡∏¥) | ‚ö†Ô∏è ‡∏°‡∏µ! (Error 3960 ‡∏´‡∏≤‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Transaction) |
| **Use Case** | ‚úÖ OLTP ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ, Azure SQL Default | üìä Report ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Consistent View |

```sql
-- ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ RCSI (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OLTP)
ALTER DATABASE [YourDB] SET READ_COMMITTED_SNAPSHOT ON;

-- ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ Snapshot Isolation
ALTER DATABASE [YourDB] SET ALLOW_SNAPSHOT_ISOLATION ON;

-- ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Snapshot ‡πÉ‡∏ô Session
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
```

> [!TIP]
> **Azure SQL Database** ‡πÄ‡∏õ‡∏¥‡∏î RCSI ‡πÄ‡∏õ‡πá‡∏ô **Default** ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÅ‡∏£‡∏Å!

### 4.2 Version Store Location

| Configuration | Version Store Location | Notes |
|:--------------|:----------------------|:------|
| **RCSI/Snapshot (No ADR)** | TempDB | ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏• TempDB size |
| **ADR Enabled** | User Database (PVS) | ‚úÖ Persistent Version Store |

> [!WARNING]
> **TempDB Full = Version Store Problems!**
> - Read operations ‡∏≠‡∏≤‡∏à fail (‡πÑ‡∏°‡πà‡∏û‡∏ö version)
> - Monitor `tempdb` space ‡πÅ‡∏•‡∏∞ `version_store_reserved_page_count`

---

## 5. Accelerated Database Recovery (ADR)
(Feature ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà SQL Server 2019 ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏õ)

### 5.1 Traditional vs ADR Recovery

```mermaid
flowchart LR
    subgraph Traditional["Traditional Recovery"]
        A1[Analysis] --> R1[Redo]
        R1 --> U1[Undo - ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö Txn Size!]
    end
    
    subgraph ADR["ADR Recovery"]
        A2[Analysis] --> R2[Redo]
        R2 --> U2[Instant Undo!]
    end
```

| Aspect | Traditional | ADR |
|:-------|:------------|:----|
| **Undo Time** | ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Uncommitted Txns | ‚úÖ **Constant time** (~‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ) |
| **Log Truncation** | ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Oldest Active Txn | ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Truncate ‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß) |
| **Version Store** | TempDB | ‚úÖ **PVS in User Database** |

### 5.2 ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ADR

```sql
-- ‡πÄ‡∏õ‡∏¥‡∏î ADR
ALTER DATABASE [YourDB] SET ACCELERATED_DATABASE_RECOVERY = ON;

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
SELECT name, is_accelerated_database_recovery_on
FROM sys.databases
WHERE name = 'YourDB';

-- ‡∏î‡∏π PVS size
SELECT 
    DB_NAME(database_id) AS [Database],
    persistent_version_store_size_kb / 1024 AS [PVS Size (MB)]
FROM sys.dm_tran_persistent_version_store_stats;
```

> [!NOTE]
> **ADR ‡πÄ‡∏õ‡πá‡∏ô Prerequisite ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Optimized Locking (SQL 2022)**

---

## 6. Lab: Analyzing Blocking and Deadlocks

**[‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡πá‡∏ö](LABS/Lab_Instructions.md)**

‡πÉ‡∏ô‡πÅ‡∏•‡πá‡∏ö‡∏ô‡∏µ‡πâ ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏á Session ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå Blocking Chain ‡πÅ‡∏•‡∏∞ Deadlock ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ DMVs

---

## 7. Review Quiz (Knowledge Check)

<details>
<summary><b>1. Isolation Level ‡πÉ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Default ‡∏Ç‡∏≠‡∏á SQL Server ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏Å‡∏¥‡∏î Blocking ‡∏™‡∏π‡∏á?</b></summary>
Read Committed (‡πÅ‡∏ö‡∏ö Pessimistic ‡∏ã‡∏∂‡πà‡∏á‡πÉ‡∏ä‡πâ Shared Lock ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô)
</details>

<details>
<summary><b>2. Lock Escalation ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÑ‡∏° SQL Server ‡∏ñ‡∏∂‡∏á‡∏ó‡∏≥?</b></summary>
‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Lock ‡πÅ‡∏ñ‡∏ß (Row) ‡πÄ‡∏õ‡πá‡∏ô Lock ‡πÇ‡∏ï‡πä‡∏∞ (Table) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Lock ‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏Å‡∏¥‡∏ô 5,000) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î Memory ‡πÅ‡∏ï‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Table ‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
</details>

<details>
<summary><b>3. ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Deadlock ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?</b></summary>
‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å Transaction (Access Objects in Order) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏ß‡∏á‡∏à‡∏£‡∏≠‡∏∏‡∏ö‡∏≤‡∏ó‡∏ß‡πå (Cycle)
</details>

